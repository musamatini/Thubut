{% extends "layout.html" %}

{% block styles %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> {# Ensure Bootstrap CSS for Modal #}
<style>
    .dashboard-header {
        background-color: #f8f9fa;
        padding: 2rem 1rem;
        margin-bottom: 2rem;
        border-radius: .3rem;
    }
    .call-section { /* Your existing call section style */
        border: 1px solid #ddd; padding: 1.5rem; border-radius: .3rem; background-color: #fff;
    }
    #participantList, .participant, .participant.speaking, .participant-info, .participant-status,
    .status-connecting, .status-new, .status-connected, .status-completed, .status-failed,
    .status-disconnected, .status-closed, .local-status.muted, .local-status, .mute-peer-btn,
    .muteBtn.muted, #remoteAudios {
        /* Keep your existing WebRTC participant styles */
    }

    /* New Styles for Quran Progress */
    .progress-section .card-header { font-weight: bold; }
    .overall-progress-bar .progress { height: 30px; font-size: 1rem; }
    .overall-progress-bar .progress-bar { transition: width 0.6s ease; }

    .juz-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); /* Responsive columns */
        gap: 1rem; /* Spacing between Juz squares */
    }
    .juz-square {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Distribute space for content */
        min-height: 120px; /* Ensure minimum height */
    }
    .juz-square:hover {
        transform: translateY(-3px) scale(1.03);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .juz-number {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 5px;
        color: #333;
    }
    .juz-percentage {
        font-size: 1em; /* Made percentage more prominent */
        color: #007bff; /* Bootstrap primary color */
        font-weight: bold;
        margin-bottom: 8px;
    }
    .juz-progress-bar-container .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef; /* Light grey background for progress bar */
        margin-bottom: 5px;
    }
    .juz-progress-bar-container .progress-bar {
        background-color: #28a745; /* Green for progress */
        transition: width 0.5s ease;
    }
    .juz-pages-info {
        font-size: 0.8em;
        color: #6c757d; /* Bootstrap muted text color */
    }

    /* Page Squares in Modal */
    #juzPagesModal .modal-dialog { max-width: 900px; } /* Wider modal for pages */
    .page-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        gap: 0.75rem;
        padding: 10px;
    }
    .page-square {
        border: 1px solid #ddd;
        height: 85px; /* Square-ish */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        position: relative; /* For potential spinner positioning */
    }
    .page-square:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .page-square.green { background-color: #d1e7dd; border-color: #a3cfbb; color: #0a3622; } /* BS5 success light */
    .page-square.orange { background-color: #fff3cd; border-color: #ffe69c; color: #664d03; }/* BS5 warning light */
    .page-square.red { background-color: #f8d7da; border-color: #f5c2c7; color: #58151c; }   /* BS5 danger light */
    .page-square.grey { background-color: #e9ecef; border-color: #dee2e6; color: #495057; } /* BS5 secondary light/muted */
    
    .page-square .page-num-quran { font-weight: bold; font-size: 0.9rem; }
    .page-square .page-num-in-juz { font-size: 0.75rem; color: #6c757d; }
    .page-square .page-mistakes { font-size: 0.7rem; margin-top: 3px; }
    .page-square .page-memorized-icon { font-size: 0.7rem; color: green; } /* If marked as memorized */

    .page-legend { display: inline-block; width: 14px; height: 14px; border-radius: 3px; margin-right: 4px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.2); }
    .page-legend.green { background-color: #d1e7dd; }
    .page-legend.orange { background-color: #fff3cd; }
    .page-legend.red { background-color: #f8d7da; }
    .page-legend.grey { background-color: #e9ecef; }
    .modal-footer small { font-size: 0.85em; }

    .spinner-grow-sm { width: 0.8rem; height: 0.8rem;}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="dashboard-header">
        <h2>Welcome, {{ current_user.fullname or current_user.username }}!</h2>
        <p class="lead">This is your Thubut dashboard. Track your progress and connect.</p>
    </div>

    <div class="row">
        <!-- Left Column: Account Status & Quran Progress -->
        <div class="col-md-5 col-lg-4 mb-4">
            <div class="card mb-4">
                <div class="card-header">Account Status</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Username:</strong> {{ current_user.username }}</li>
                    <li class="list-group-item">
                        <strong>Email:</strong> {{ current_user.email }}
                        {% if current_user.email_confirmed %}
                            <span class="badge bg-success float-end">Confirmed</span>
                        {% else %}
                            <span class="badge bg-warning float-end">Not Confirmed</span>
                            <br><small><a href="{{ url_for('verify_email') }}">Verify Email Now</a></small>
                        {% endif %}
                    </li>
                    <li class="list-group-item">
                        <strong>Phone:</strong>
                        {% if current_user.phone_number %}
                            {{ current_user.phone_number }}
                            {% if current_user.phone_confirmed %}
                                <span class="badge bg-success float-end">Confirmed</span>
                            {% else %}
                                <span class="badge bg-warning float-end">Not Confirmed</span>
                                <br><small><a href="{{ url_for('verify_phone') }}">Verify Phone Now</a></small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not Provided</span>
                            {# <br><small><a href="#">Add Phone</a></small> #}
                        {% endif %}
                    </li>
                     <li class="list-group-item"><strong>Role:</strong> {{ current_user.role }}</li>
                </ul>
            </div>
            
            <div class="card mb-4 progress-section">
                <div class="card-header">Overall Quran Progress</div>
                <div class="card-body overall-progress-bar">
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ overall_quran_progress_percent }}%;" aria-valuenow="{{ overall_quran_progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                            {{ overall_quran_progress_percent }}%
                        </div>
                    </div>
                    <p class="mt-2 text-center text-muted">
                        <span id="memorizedPagesCount">{{ (overall_quran_progress_percent * QURAN_TOTAL_PAGES / 100) | round | int }}</span> / <span id="totalQuranPages">{{ QURAN_TOTAL_PAGES }}</span> pages memorized.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Quick Actions</div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action">Edit Profile</a>
                    <a href="{{ url_for('logout') }}" class="list-group-item list-group-item-action">Logout</a>
                </div>
            </div>
        </div>

        <!-- Right Column: Juz Progress & Call Section -->
        <div class="col-md-7 col-lg-8 mb-4">
            <div class="card mb-4 progress-section">
                <div class="card-header">Juz Progress Overview</div>
                <div class="card-body">
                    <div class="juz-grid">
                        {% for juz in juz_progress_data %}
                        <div class="juz-square" data-juz-number="{{ juz.juz_number }}" title="Click to view pages for Juz {{ juz.juz_number }}">
                            <div class="juz-number">Juz {{ juz.juz_number }}</div>
                            <div class="juz-percentage">{{ juz.completion_percent }}%</div>
                            <div class="juz-progress-bar-container">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ juz.completion_percent }}%;" aria-valuenow="{{ juz.completion_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="juz-pages-info">{{juz.memorized_pages}} / {{juz.total_pages}} pgs</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="call-section"> {# Your existing call section #}
                <h3>Voice Calls</h3>
                 {% if not current_user.email_confirmed %}
                <div class="alert alert-warning">
                    Please <a href="{{ url_for('verify_email') }}">verify your email</a> to use the voice call feature.
                </div>
                {% elif current_user.phone_number and not current_user.phone_confirmed %}
                <div class="alert alert-warning">
                    Please <a href="{{ url_for('verify_phone') }}">verify your phone number</a> to use the voice call feature fully.
                </div>
                {% else %}
                <div id="callControls">
                    <div class="input-group mb-3">
                        <input type="text" id="room" class="form-control" placeholder="Enter Room ID to Join or Create">
                        <button id="joinBtn" class="btn btn-success" onclick="joinCall()">Join/Create Room</button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <button id="leaveBtn" class="btn btn-danger" onclick="leaveCall()" disabled>Leave Call</button>
                        <button id="muteBtn" class="btn btn-secondary" onclick="toggleMute()" disabled>Mute</button>
                    </div>
                    <div id="status" class="form-text mt-2">Enter a Room ID to join or create a call.</div>
                </div>
                <h4 class="mt-4">Participants:</h4>
                <div id="participantList"></div>
                <div id="remoteAudios"></div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Page Details -->
    <div class="modal fade" id="juzPagesModal" tabindex="-1" aria-labelledby="juzPagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable"> {# modal-xl for wider, modal-dialog-scrollable for long content #}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="juzPagesModalLabel">Pages for Juz X</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="juzPagesContainer" class="page-grid">
                        <!-- Page squares will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer justify-content-start"> {# Legends on the left #}
                    <small>
                        <span class="page-legend green"></span> 0 Mistakes  
                        <span class="page-legend orange"></span> 1-3 Mistakes  
                        <span class="page-legend red"></span> >3 Mistakes  
                        <span class="page-legend grey"></span> Not Memorized / No Data
                    </small>
                    <button type="button" class="btn btn-secondary ms-auto" data-bs-dismiss="modal">Close</button> {# Close button to the right #}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Ensure Bootstrap JS is loaded (likely in layout.html, but can be here too) #}
{# <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> #}

{% if current_user.is_authenticated %} {# Socket.IO and WebRTC for authenticated users #}
    {# <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script> -- Already in layout #}
    <script src="{{ url_for('static', filename='js/webrtc.js') }}"></script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const juzSquares = document.querySelectorAll('.juz-square');
    const juzPagesModalElement = document.getElementById('juzPagesModal');
    const juzPagesModal = new bootstrap.Modal(juzPagesModalElement);
    const juzPagesContainer = document.getElementById('juzPagesContainer');
    const juzPagesModalLabel = document.getElementById('juzPagesModalLabel');
    const csrfToken = "{{ csrf_token() }}"; // Make sure CSRF is enabled and token available

    // For updating overall progress dynamically
    const overallProgressBar = document.querySelector('.overall-progress-bar .progress-bar');
    const memorizedPagesCountEl = document.getElementById('memorizedPagesCount');
    const totalQuranPages = parseInt(document.getElementById('totalQuranPages').textContent);

    juzSquares.forEach(square => {
        square.addEventListener('click', function() {
            const juzNumber = this.dataset.juzNumber;
            juzPagesModalLabel.textContent = `Memorization Status for Juz ${juzNumber}`;
            loadJuzPages(juzNumber);
        });
    });

    async function loadJuzPages(juzNumber) {
        juzPagesContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading pages...</span>
                                            </div>
                                       </div>`;
        juzPagesModal.show();

        try {
            const response = await fetch(`/api/progress/juz/${juzNumber}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            renderPagesInModal(data, juzNumber);
        } catch (error) {
            juzPagesContainer.innerHTML = `<div class="alert alert-danger m-3">Error loading page details: ${error.message}</div>`;
            console.error('Error fetching juz pages:', error);
        }
    }

    function renderPagesInModal(data, juzNumber) {
        juzPagesContainer.innerHTML = ''; // Clear loader/previous content
        if (!data.pages || data.pages.length === 0) {
            juzPagesContainer.innerHTML = '<p class="text-center text-muted p-3">No page data available for this Juz.</p>';
            return;
        }

        data.pages.forEach(page => {
            const pageSquare = document.createElement('div');
            pageSquare.classList.add('page-square', page.status_color);
            pageSquare.dataset.pageQuran = page.page_number_quran;
            pageSquare.dataset.isMemorized = page.is_memorized.toString(); // Store as string for consistency
            pageSquare.setAttribute('title', `Page ${page.page_number_quran} (Juz ${juzNumber}, Page ${page.page_number_in_juz})\nStatus: ${page.is_memorized ? 'Memorized' : 'Not Memorized'}\nMistakes: ${page.mistakes_count}\nClick to toggle memorization.`);


            let mistakeText = page.is_memorized ? `Mistakes: ${page.mistakes_count}` : ' ';
            // You can add an icon for memorized pages if you like:
            // let memorizedIcon = page.is_memorized ? '<span class="page-memorized-icon">✔</span>' : '';

            pageSquare.innerHTML = `
                <div class="page-num-quran">P. ${page.page_number_quran}</div>
                <div class="page-num-in-juz">J${juzNumber}, #${page.page_number_in_juz}</div>
                <div class="page-mistakes">${mistakeText}</div>
            `;
            
            pageSquare.addEventListener('click', function() {
                togglePageMemorization(this, page.page_number_quran, page.is_memorized, juzNumber);
            });
            juzPagesContainer.appendChild(pageSquare);
        });
    }

    async function togglePageMemorization(pageElement, pageQuranNum, isCurrentlyMemorized, currentJuzNumber) {
        const url = isCurrentlyMemorized ?
            `/api/progress/unmark_page_memorized/${pageQuranNum}` :
            `/api/progress/mark_page_memorized/${pageQuranNum}`;
        
        // Add a small visual spinner to the clicked page square
        const spinner = document.createElement('div');
        spinner.className = 'spinner-grow spinner-grow-sm text-secondary';
        spinner.style.position = 'absolute';
        spinner.style.bottom = '5px';
        spinner.style.right = '5px';
        pageElement.appendChild(spinner);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Failed to update page ${pageQuranNum}`);
            }
            
            // const result = await response.json(); // Contains success message
            // For a smoother experience, reload the specific Juz data to update the modal
            // and also update the main dashboard Juz square and overall progress.
            await loadJuzPages(currentJuzNumber); // Reloads modal content with fresh data
            await updateDashboardProgress(); // Updates main dashboard elements

        } catch (error) {
            console.error('Error toggling page memorization:', error);
            alert(`Error: ${error.message}`);
        } finally {
            // Remove spinner regardless of outcome
            if (pageElement.contains(spinner)) {
                pageElement.removeChild(spinner);
            }
        }
    }

    async function updateDashboardProgress() {
        // This function would re-fetch the necessary data to update the main dashboard.
        // For simplicity here, we'll assume the backend recalculates on next dashboard load.
        // A more robust way is to have an API endpoint that returns updated
        // overall_quran_progress_percent and juz_progress_data.
        // Or, even simpler for now, just reload the page after modal closes if changes were made.
        // However, for a better UX, let's try to update parts of it client-side if possible,
        // or make a dedicated API call.

        // Simplest: fetch overall progress. A dedicated API for this would be better.
        // For now, let's just assume the backend is the source of truth and
        // this simple demo will require a page refresh for full dashboard update
        // or a more complex client-side state management.

        // For this example, we'll just make a note. A full update would involve:
        // 1. Fetching updated overall progress percentage and count.
        // 2. Fetching updated progress for *each* Juz to update the Juz squares.
        // This can be slow. The current implementation reloads the Juz modal,
        // and the main dashboard will update on next full page load/refresh.

        // Let's attempt a partial update of the overall progress by re-fetching the dashboard data (less ideal but demonstrates)
        // Or, if you modify the dashboard route to return JSON for AJAX, that's better.
        // For now, we acknowledge this part could be more sophisticated.
        
        // Quick (but not fully accurate without backend call for new overall %):
        // Recalculate client side is error prone. Best to fetch from backend.
        // Let's assume for now that the user will see main dashboard updates on next refresh.
        // The modal will be accurate.
        
        // To update the main dashboard Juz square after changes in modal:
        // We need to know which Juz was modified. We have `currentJuzNumber`.
        // We'd need to fetch its new completion percentage.

        // To refresh the specific Juz square on the main dashboard:
        // Fetch its individual updated stats. E.g. /api/juz_summary/<juz_number>
        // For now, this part is omitted for brevity but is an important UX improvement.
        console.log("Main dashboard progress would ideally be updated here via another API call or full refresh.");

    }

});
</script>
{% endblock %}